[build]
  command = "yarn build"
  publish = "dist"
  functions = "netlify/functions"
  targetPort = 5173

[build.environment]
  NODE_VERSION = "24"
  # Ubuntu Noble 24.04 is the default build image

[[headers]]
  for = "/index.html"
  [headers.values]
    Cache-Control = "no-cache, no-store, must-revalidate"
    Pragma = "no-cache"
    Expires = "0"

[[headers]]
  for = "/service-worker.js"
  [headers.values]
    Content-Type = "application/javascript"
    Cache-Control = "no-cache, no-store, must-revalidate"
    Pragma = "no-cache"
    Expires = "0"

[[headers]]
  for = "/assets/*.js"
  [headers.values]
    Content-Type = "application/javascript"
    X-Content-Type-Options = "nosniff"
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/assets/*.css"
  [headers.values]
    Content-Type = "text/css"
    X-Content-Type-Options = "nosniff"
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/assets/*.json"
  [headers.values]
    Content-Type = "application/json"
    X-Content-Type-Options = "nosniff"
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/assets/*.png"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[redirects]]
  from = "/share-redirect.html"
  to = "/share-redirect.html"
  status = 200

# Share Target: Route POST to Netlify function as fallback when service worker isn't installed
# This is CRITICAL for first-time users who share before installing the PWA
# The service worker will intercept if installed, otherwise this fallback handles it
# Handle both with and without trailing slash
[[redirects]]
  from = "/share-target/"
  to = "/.netlify/functions/share-target"
  status = 200
  force = true

[[redirects]]
  from = "/share-target"
  to = "/.netlify/functions/share-target"
  status = 200
  force = true

# Exclude assets from SPA fallback - must come before catch-all
# This handles all assets including manifest.json, CSS, JS files
[[redirects]]
  from = "/assets/*"
  to = "/assets/:splat"
  status = 200
  force = true

# Exclude service worker from SPA fallback
[[redirects]]
  from = "/service-worker.js"
  to = "/service-worker.js"
  status = 200
  force = true

# Exclude favicon from SPA fallback
[[redirects]]
  from = "/favicon.png"
  to = "/favicon.png"
  status = 200
  force = true

# SPA fallback - must be last
# Note: /share-target/ POST requests are handled by the Netlify function above
# when service worker isn't installed (first-time users)
[[redirects]]
  from = "/*"
  to = "/index.html"
  status = 200